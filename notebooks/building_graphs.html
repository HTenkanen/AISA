

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Building custom graphs - Car routing &#8212; Introduction to Spatial Analytics  documentation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="../_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
    <script >var togglebuttonSelector = '.toggle';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    


    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar">
<a class="navbar-brand" href="../index.html">
  <img src="../_static/Intro-spatial-analytics.png" class="logo" alt="logo">
</a>



<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
    <i class="icon fas fa-search"></i>
    <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
  </form>

  <nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

    <div class="bd-toc-item active">
    



    <ul class="nav bd-sidenav">
        
        <li class="nav-item ">
            <a class="nav-link" href="../course_information.html">Course information</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../analysis_workflow.html">Introduction to Spatial Analytics</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="data_aquisition.html">Spatial data aquisition, cleaning, filtering and classification</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="point_pattern_analysis.html">Point pattern analysis</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="clustering.html">Clustering</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="spatial_autocorrelation.html">Spatial autocorrelation</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="spatial_interpolation.html">Spatial Interpolation</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="spatial_network_analysis.html">Spatial Network analysis</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="spatial_regression.html">Spatial Regression</a>
        </li>
        
    </ul>

  </nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#retrieve-the-digiroad-data" class="nav-link">1. Retrieve the Digiroad data</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#input-data-links" class="nav-link">Input data: Links</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#input-data-speedlimits" class="nav-link">Input data: Speedlimits</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#input-data-traffic-lights" class="nav-link">Input data: Traffic lights</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#modify-the-street-network-apply-intersection-delays" class="nav-link">2. Modify the street network - Apply intersection delays</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#build-the-graph" class="nav-link">3. Build the graph</a>
        </li>
    
    </ul>
</nav>


              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="building-custom-graphs-car-routing">
<h1>Building custom graphs - Car routing<a class="headerlink" href="#building-custom-graphs-car-routing" title="Permalink to this headline">¶</a></h1>
<p>In the previous section, we learned some basic tricks how to do routing
with Python.</p>
<p>Now we will learn how to build a custom NetworkX graph from scratch
using Digiroad street network data (national road dataset for Finland).</p>
<p>We will again follow the same steps that we described in previous
tutorial, i.e. we will:</p>
<ol class="arabic simple">
<li><p><strong>Retrieve data</strong></p></li>
<li><p><strong>Modify the network</strong> by applying custom edge weights considering
traffic conditions for car.</p></li>
<li><p><strong>Build a routable graph</strong> for NetworkX (plus there is a example how
to do this for iGraph as well)</p></li>
<li><p><strong>Conduct network analysis</strong></p></li>
</ol>
<div class="section" id="retrieve-the-digiroad-data">
<h2>1. Retrieve the Digiroad data<a class="headerlink" href="#retrieve-the-digiroad-data" title="Permalink to this headline">¶</a></h2>
<p>Digiroad data is openly available from
<a class="reference external" href="https://aineistot.vayla.fi/digiroad/">digiroad.fi</a> website (operated
by Väylä). I have included a small GeoPackage in this repository
(data/test_Digiroad.gpkg) that we can use now. If you want to download
your own data, you want to use the K-format of the Digiroad data (in
better format for routing). Digiroad releases the datasets in Shapefile
format in regional level, and as a GeoPackage covering the whole
Finland. We will use here a subset of the dataset convering the whole
Finland (in GeoPackage format).</p>
<p>In the data, we are primarily interested in three separate datasets:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">DR_LINKKI_K</span></code> (the edges = most important dataset)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DR_NOPEUSRAJOITUS_K</span></code> (speed limit information)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DR_LIIKENNEVALO</span></code> (traffic lights)</p></li>
<li><p>Let’s read the test dataset</p></li>
</ul>
<div class="jupyter_container docutils container">
<div class="code_cell highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">osmnx</span> <span class="k">as</span> <span class="nn">ox</span>

<span class="c1"># Filepath</span>
<span class="n">fp</span> <span class="o">=</span> <span class="s2">&quot;data/test_Digiroad.gpkg&quot;</span>

<span class="c1"># In the GeoPackage there are three layers (we are interested in all of them)</span>
<span class="n">links</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s1">&#39;DR_LINKKI_K&#39;</span><span class="p">)</span>
<span class="n">speedlimits</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s1">&#39;DR_NOPEUSRAJOITUS_K&#39;</span><span class="p">)</span>
<span class="n">signals</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s1">&#39;DR_LIIKENNEVALO&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">CPLE_OpenFailedError</span><span class="g g-Whitespace">                      </span>Traceback (most recent call last)
<span class="nn">fiona/_shim.pyx</span> in <span class="ni">fiona._shim.gdal_open_vector</span><span class="nt">()</span>

<span class="nn">fiona/_err.pyx</span> in <span class="ni">fiona._err.exc_wrap_pointer</span><span class="nt">()</span>

<span class="ne">CPLE_OpenFailedError</span>: data/test_Digiroad.gpkg: No such file or directory

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="ne">DriverError</span><span class="g g-Whitespace">                               </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">d0a8858a5f59</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> 
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="c1"># In the GeoPackage there are three layers (we are interested in all of them)</span>
<span class="ne">----&gt; </span><span class="mi">9</span> <span class="n">links</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s1">&#39;DR_LINKKI_K&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="n">speedlimits</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s1">&#39;DR_NOPEUSRAJOITUS_K&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="n">signals</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s1">&#39;DR_LIIKENNEVALO&#39;</span><span class="p">)</span>

<span class="nn">~/miniconda3/envs/python-gis/lib/python3.8/site-packages/geopandas/io/file.py</span> in <span class="ni">read_file</span><span class="nt">(filename, bbox, mask, rows, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">87</span> 
<span class="g g-Whitespace">     </span><span class="mi">88</span>     <span class="k">with</span> <span class="n">fiona_env</span><span class="p">():</span>
<span class="ne">---&gt; </span><span class="mi">89</span>         <span class="k">with</span> <span class="n">reader</span><span class="p">(</span><span class="n">path_or_bytes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">features</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">90</span> 
<span class="g g-Whitespace">     </span><span class="mi">91</span>             <span class="c1"># In a future Fiona release the crs attribute of features will</span>

<span class="nn">~/miniconda3/envs/python-gis/lib/python3.8/site-packages/fiona/env.py</span> in <span class="ni">wrapper</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">396</span>     <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">397</span>         <span class="k">if</span> <span class="n">local</span><span class="o">.</span><span class="n">_env</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">398</span>             <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">399</span>         <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">400</span>             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>

<span class="nn">~/miniconda3/envs/python-gis/lib/python3.8/site-packages/fiona/__init__.py</span> in <span class="ni">open</span><span class="nt">(fp, mode, driver, schema, crs, encoding, layer, vfs, enabled_drivers, crs_wkt, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span> 
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">253</span>             <span class="n">c</span> <span class="o">=</span> <span class="n">Collection</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="n">driver</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">254</span>                            <span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> <span class="n">enabled_drivers</span><span class="o">=</span><span class="n">enabled_drivers</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">255</span>         <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span>

<span class="nn">~/miniconda3/envs/python-gis/lib/python3.8/site-packages/fiona/collection.py</span> in <span class="ni">__init__</span><span class="nt">(self, path, mode, driver, schema, crs, encoding, layer, vsi, archive, enabled_drivers, crs_wkt, ignore_fields, ignore_geometry, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">152</span>             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">153</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
<span class="ne">--&gt; </span><span class="mi">154</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">155</span>             <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">156</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">WritingSession</span><span class="p">()</span>

<span class="nn">fiona/ogrext.pyx</span> in <span class="ni">fiona.ogrext.Session.start</span><span class="nt">()</span>

<span class="nn">fiona/_shim.pyx</span> in <span class="ni">fiona._shim.gdal_open_vector</span><span class="nt">()</span>

<span class="ne">DriverError</span>: data/test_Digiroad.gpkg: No such file or directory
</pre></div>
</div>
</div>
<p>Okay, now we have read all the required datasets, let’s take a quick
look what they contain.</p>
<div class="section" id="input-data-links">
<h3>Input data: Links<a class="headerlink" href="#input-data-links" title="Permalink to this headline">¶</a></h3>
<div class="jupyter_container docutils container">
<div class="code_cell highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check links</span>
<span class="n">links</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="mi">41</span><span class="n">eeb1e0fe28</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># Check links</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">links</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;links&#39; is not defined
</pre></div>
</div>
</div>
<div class="jupyter_container docutils container">
<div class="code_cell highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">links</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="mi">374131</span><span class="n">d29f2a</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">links</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;links&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="section" id="input-data-speedlimits">
<h3>Input data: Speedlimits<a class="headerlink" href="#input-data-speedlimits" title="Permalink to this headline">¶</a></h3>
<div class="jupyter_container docutils container">
<div class="code_cell highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">speedlimits</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">4</span><span class="o">-</span><span class="n">a5faec628a09</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">speedlimits</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;speedlimits&#39; is not defined
</pre></div>
</div>
</div>
<div class="jupyter_container docutils container">
<div class="code_cell highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">speedlimits</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">77</span><span class="n">f034dcfbfc</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">speedlimits</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;speedlimits&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="section" id="input-data-traffic-lights">
<h3>Input data: Traffic lights<a class="headerlink" href="#input-data-traffic-lights" title="Permalink to this headline">¶</a></h3>
<div class="jupyter_container docutils container">
<div class="code_cell highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">signals</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">a66a02531d67</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">signals</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;signals&#39; is not defined
</pre></div>
</div>
</div>
<div class="jupyter_container docutils container">
<div class="code_cell highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">signals</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">7</span><span class="o">-</span><span class="n">d8964a751f40</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">signals</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;signals&#39; is not defined
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="modify-the-street-network-apply-intersection-delays">
<h2>2. Modify the street network - Apply intersection delays<a class="headerlink" href="#modify-the-street-network-apply-intersection-delays" title="Permalink to this headline">¶</a></h2>
<p>Next we want to modify our street network a bit by calculating
drivethrough times for each road segment and apply a so called
intersection delay model for the road network, that makes the drive
times more realistic by taking into account traffic conditions at
different times of the day (see Jaakkola 2013).</p>
<p>We can do this by importing and using a function from our toolset called
<code class="docutils literal notranslate"><span class="pre">apply_intersection_delays</span></code>. This tool does various things and we do
not have time to go through the model, but basically what it does, is
that it adds additional delays to roads that are affected by different
type of intersections. These delays are based on floating car
measurements (GPS tracks).</p>
<div class="jupyter_container docutils container">
<div class="code_cell highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tools</span> <span class="kn">import</span> <span class="n">apply_intersection_delays</span>
<span class="n">help</span><span class="p">(</span><span class="n">apply_intersection_delays</span><span class="p">)</span>
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="mi">9511</span><span class="n">a0abf4b9</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">tools</span> <span class="kn">import</span> <span class="n">apply_intersection_delays</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">help</span><span class="p">(</span><span class="n">apply_intersection_delays</span><span class="p">)</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;tools&#39;
</pre></div>
</div>
</div>
<p>As we can see, this tool requires that you have three datasets
(mentioned above) as GeoDataFrames and you pass them into the function
<code class="docutils literal notranslate"><span class="pre">apply_intersection_delays</span></code>. As a result you get the modified street
network (GeoDataFrame) with drive through-times:</p>
<div class="jupyter_container docutils container">
<div class="code_cell highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dr_data</span> <span class="o">=</span> <span class="n">apply_intersection_delays</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">speedlimits</span><span class="p">,</span> <span class="n">signals</span><span class="p">)</span>
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">9</span><span class="o">-</span><span class="mi">0</span><span class="n">a7d0eceff5a</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">dr_data</span> <span class="o">=</span> <span class="n">apply_intersection_delays</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">speedlimits</span><span class="p">,</span> <span class="n">signals</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;apply_intersection_delays&#39; is not defined
</pre></div>
</div>
</div>
<div class="jupyter_container docutils container">
<div class="code_cell highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># What did we get?</span>
<span class="n">dr_data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">1</span><span class="n">c79e38e04af</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># What did we get?</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">dr_data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;dr_data&#39; is not defined
</pre></div>
</div>
</div>
<p>Great! As a result, we now have GeoDataFrame with few new attributes
that we can use for routing:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Pituus</span></code> = length in meters</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Digiroa_aa</span></code> = drive through time based on speed limits only</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Kokopva_aa</span></code>= drive through time following average traffic
conditions (whole day)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Keskpva_aa</span></code>= drive through time following midday traffic
conditions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Ruuhka_aa</span></code>= drive through time following rush hour traffic
conditions</p></li>
</ul>
</div>
<div class="section" id="build-the-graph">
<h2>3. Build the graph<a class="headerlink" href="#build-the-graph" title="Permalink to this headline">¶</a></h2>
<p>Next, we want to build a graph from this data. For convenience, I have
written a function called <code class="docutils literal notranslate"><span class="pre">build_graph_from_Digiroad</span></code> (in
tools/graphio.py) that we can straight away use to build the graph (at
the end of this notebook, we go through the logic how the graphs are
built).</p>
<ul class="simple">
<li><p>Let’s first import it, and see how it should be used</p></li>
</ul>
<div class="jupyter_container docutils container">
<div class="code_cell highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tools</span> <span class="kn">import</span> <span class="n">build_graph_from_Digiroad</span>

<span class="c1"># Print the &quot;manual&quot;</span>
<span class="n">help</span><span class="p">(</span><span class="n">build_graph_from_Digiroad</span><span class="p">)</span>
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="n">de1269a09f5b</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">tools</span> <span class="kn">import</span> <span class="n">build_graph_from_Digiroad</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> 
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="c1"># Print the &quot;manual&quot;</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">help</span><span class="p">(</span><span class="n">build_graph_from_Digiroad</span><span class="p">)</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;tools&#39;
</pre></div>
</div>
</div>
<p>Okay, as we can see this function wants to have a GeoDataFrame of
Digiroad and information about which column contains information about
the allowed driving direction (i.e. <code class="docutils literal notranslate"><span class="pre">AJOSUUNTA</span></code>), and which value
corresponds to which direction. The default values work with the current
version of the Digiroad and the default values should work fine with the
function.</p>
<ul class="simple">
<li><p>Let’s build the graph from Digiroad:</p></li>
</ul>
<div class="jupyter_container docutils container">
<div class="code_cell highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build the graph</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">build_graph_from_Digiroad</span><span class="p">(</span><span class="n">dr_data</span><span class="p">)</span>

<span class="c1"># Check type</span>
<span class="n">G</span>
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">9</span><span class="n">d911b4e0596</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># Build the graph</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">G</span> <span class="o">=</span> <span class="n">build_graph_from_Digiroad</span><span class="p">(</span><span class="n">dr_data</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> 
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="c1"># Check type</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">G</span>

<span class="ne">NameError</span>: name &#39;build_graph_from_Digiroad&#39; is not defined
</pre></div>
</div>
</div>
<p>Great! Now we have built a similar NetworkX graph as we did previously
with OSM data using OSMnx -package.</p>
<p>Because we have built a similar graph as with walking and cycling
previously, we can follow more or less the same steps when routing with
car. We can also use the same functions from OSMnx as before! So we
will:</p>
<ol class="arabic simple">
<li><p>Find the nearest node for origin location (+ get info about its
node-id and distance between origin and node)</p></li>
<li><p>Find the nearest node for destination location (+ get info about its
node-id and distance between origin and node)</p></li>
<li><p>Use a routing algorithm to find the shortest path between A and B</p></li>
<li><p>Retrieve edge attributes for the given route(s) and summarize them</p></li>
</ol>
<ul class="simple">
<li><p>Let’s first plot the graph</p></li>
</ul>
<div class="jupyter_container docutils container">
<div class="code_cell highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ox</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">13</span><span class="o">-</span><span class="n">b949a4ab7c6f</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">ox</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;G&#39; is not defined
</pre></div>
</div>
</div>
<p>As we can see, we have now a bit larger graph than before, and we can
make longer trips.</p>
<ul class="simple">
<li><p>Let’s find the fastest route from Otaniemi campus to Helsinki city
center campus using the midday impedance:</p></li>
</ul>
<div class="jupyter_container docutils container">
<div class="code_cell highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Addresses</span>
<span class="c1"># Origin</span>
<span class="n">orig_address</span> <span class="o">=</span> <span class="s2">&quot;Otakaari 12, Espoo&quot;</span>
<span class="n">orig_y</span><span class="p">,</span> <span class="n">orig_x</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">geocode</span><span class="p">(</span><span class="n">orig_address</span><span class="p">)</span>  <span class="c1"># notice the coordinate order (y, x)!</span>

<span class="c1"># Destination</span>
<span class="n">dest_address</span> <span class="o">=</span> <span class="s2">&quot;Fabianinkatu 33, Helsinki&quot;</span>
<span class="n">dest_y</span><span class="p">,</span> <span class="n">dest_x</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">geocode</span><span class="p">(</span><span class="n">dest_address</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="jupyter_container docutils container">
<div class="code_cell highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. Find the closest nodes for origin and destination</span>
<span class="n">orig_node_id</span><span class="p">,</span> <span class="n">dist_to_orig</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">get_nearest_node</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="p">(</span><span class="n">orig_y</span><span class="p">,</span> <span class="n">orig_x</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;haversine&#39;</span><span class="p">,</span> <span class="n">return_dist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">dest_node_id</span><span class="p">,</span> <span class="n">dist_to_dest</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">get_nearest_node</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="p">(</span><span class="n">dest_y</span><span class="p">,</span> <span class="n">dest_x</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;haversine&#39;</span><span class="p">,</span> <span class="n">return_dist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">15</span><span class="o">-</span><span class="mi">9586</span><span class="n">eb389b83</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># 1. Find the closest nodes for origin and destination</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">orig_node_id</span><span class="p">,</span> <span class="n">dist_to_orig</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">get_nearest_node</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="p">(</span><span class="n">orig_y</span><span class="p">,</span> <span class="n">orig_x</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;haversine&#39;</span><span class="p">,</span> <span class="n">return_dist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">dest_node_id</span><span class="p">,</span> <span class="n">dist_to_dest</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">get_nearest_node</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="p">(</span><span class="n">dest_y</span><span class="p">,</span> <span class="n">dest_x</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;haversine&#39;</span><span class="p">,</span> <span class="n">return_dist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;G&#39; is not defined
</pre></div>
</div>
</div>
<div class="jupyter_container docutils container">
<div class="code_cell highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 2. Calculate the shortest paths by car during midday</span>
<span class="n">midday_path</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">dijkstra_path</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">orig_node_id</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">dest_node_id</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;Keskpva_aa&#39;</span><span class="p">)</span>

<span class="c1"># Get also the actual travel time (summarize)</span>
<span class="n">midday_t</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">dijkstra_path_length</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">orig_node_id</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">dest_node_id</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;Keskpva_aa&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">454</span><span class="n">c4a075f02</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># 2. Calculate the shortest paths by car during midday</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">midday_path</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">dijkstra_path</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">orig_node_id</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">dest_node_id</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;Keskpva_aa&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> 
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="c1"># Get also the actual travel time (summarize)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">midday_t</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">dijkstra_path_length</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">orig_node_id</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">dest_node_id</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;Keskpva_aa&#39;</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;G&#39; is not defined
</pre></div>
</div>
</div>
<p>Plotting with custom weight attributes in OSMnx is currently not
possible. Hence, we need to modify slightly the plotting functions, so
that we can easily plot our paths:</p>
<div class="jupyter_container docutils container">
<div class="code_cell highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">node_list_to_coordinate_lines</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">node_list</span><span class="p">,</span> <span class="n">use_geom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">weight_col</span><span class="o">=</span><span class="s1">&#39;length&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Obtained from OSMnx with custom weight_col.&quot;&quot;&quot;</span>
    <span class="n">edge_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">node_list</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">node_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">edge_nodes</span><span class="p">:</span>
        <span class="c1"># if there are parallel edges, select the shortest in length</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">weight_col</span><span class="p">])</span>

        <span class="c1"># if it has a geometry attribute (ie, a list of line segments)</span>
        <span class="k">if</span> <span class="s1">&#39;geometry&#39;</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">use_geom</span><span class="p">:</span>
            <span class="c1"># add them to the list of lines to plot</span>
            <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">xy</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if it doesn&#39;t have a geometry attribute, the edge is a straight</span>
            <span class="c1"># line from node to node</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)]</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lines</span>

<span class="k">def</span> <span class="nf">plot_graph_route</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">weight_col</span><span class="o">=</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig_height</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">fig_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">margin</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">bgcolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">axis_off</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file_format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span>
                     <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">annotate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;#999999&#39;</span><span class="p">,</span>
                     <span class="n">node_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">node_alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">node_edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                     <span class="n">node_zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;#999999&#39;</span><span class="p">,</span> <span class="n">edge_linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">edge_alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">use_geom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">origin_point</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">destination_point</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">route_color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">route_linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                     <span class="n">route_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">orig_dest_node_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                     <span class="n">orig_dest_node_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">orig_dest_node_color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                     <span class="n">orig_dest_point_color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modified from OSMnx with custom weight_col, see:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">matplotlib.collections</span> <span class="kn">import</span> <span class="n">LineCollection</span>

    <span class="c1"># plot the graph but not the route</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">,</span> <span class="n">fig_height</span><span class="o">=</span><span class="n">fig_height</span><span class="p">,</span> <span class="n">fig_width</span><span class="o">=</span><span class="n">fig_width</span><span class="p">,</span>
                         <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span> <span class="n">axis_off</span><span class="o">=</span><span class="n">axis_off</span><span class="p">,</span> <span class="n">bgcolor</span><span class="o">=</span><span class="n">bgcolor</span><span class="p">,</span>
                         <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                         <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">annotate</span><span class="o">=</span><span class="n">annotate</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="n">node_color</span><span class="p">,</span>
                         <span class="n">node_size</span><span class="o">=</span><span class="n">node_size</span><span class="p">,</span> <span class="n">node_alpha</span><span class="o">=</span><span class="n">node_alpha</span><span class="p">,</span>
                         <span class="n">node_edgecolor</span><span class="o">=</span><span class="n">node_edgecolor</span><span class="p">,</span> <span class="n">node_zorder</span><span class="o">=</span><span class="n">node_zorder</span><span class="p">,</span>
                         <span class="n">edge_color</span><span class="o">=</span><span class="n">edge_color</span><span class="p">,</span> <span class="n">edge_linewidth</span><span class="o">=</span><span class="n">edge_linewidth</span><span class="p">,</span>
                         <span class="n">edge_alpha</span><span class="o">=</span><span class="n">edge_alpha</span><span class="p">,</span> <span class="n">use_geom</span><span class="o">=</span><span class="n">use_geom</span><span class="p">)</span>

    <span class="c1"># the origin and destination nodes are the first and last nodes in the route</span>
    <span class="n">origin_node</span> <span class="o">=</span> <span class="n">route</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">destination_node</span> <span class="o">=</span> <span class="n">route</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">origin_point</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">destination_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># if caller didn&#39;t pass points, use the first and last node in route as</span>
        <span class="c1"># origin/destination</span>
        <span class="n">origin_destination_lats</span> <span class="o">=</span> <span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">origin_node</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">destination_node</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
        <span class="n">origin_destination_lons</span> <span class="o">=</span> <span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">origin_node</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">destination_node</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># otherwise, use the passed points as origin/destination</span>
        <span class="n">origin_destination_lats</span> <span class="o">=</span> <span class="p">(</span><span class="n">origin_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">destination_point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">origin_destination_lons</span> <span class="o">=</span> <span class="p">(</span><span class="n">origin_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">destination_point</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">orig_dest_node_color</span> <span class="o">=</span> <span class="n">orig_dest_point_color</span>

    <span class="c1"># scatter the origin and destination points</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">origin_destination_lons</span><span class="p">,</span> <span class="n">origin_destination_lats</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">orig_dest_node_size</span><span class="p">,</span>
               <span class="n">c</span><span class="o">=</span><span class="n">orig_dest_node_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">orig_dest_node_alpha</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">node_edgecolor</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># plot the route lines</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">node_list_to_coordinate_lines</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">use_geom</span><span class="p">,</span> <span class="n">weight_col</span><span class="p">)</span>

    <span class="c1"># add the lines to the axis as a linecollection</span>
    <span class="n">lc</span> <span class="o">=</span> <span class="n">LineCollection</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">route_color</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="n">route_linewidth</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">route_alpha</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>

    <span class="c1"># save and show the figure as specified</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">save_and_show</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">show</span><span class="p">,</span> <span class="n">close</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">file_format</span><span class="p">,</span> <span class="n">dpi</span><span class="p">,</span> <span class="n">axis_off</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
</pre></div>
</div>
</div>
<div class="jupyter_container docutils container">
<div class="code_cell highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s plot our path with the custom functions</span>
<span class="c1"># Visualize static map</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_graph_route</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">midday_path</span><span class="p">,</span> <span class="n">weight_col</span><span class="o">=</span><span class="s1">&#39;Keskpva_aa&#39;</span><span class="p">)</span>

<span class="c1"># Add the travel time as title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Drive time </span><span class="si">{t: .1f}</span><span class="s2"> minutes.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">midday_t</span><span class="p">))</span>
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">18</span><span class="o">-</span><span class="n">d9cc1ec50401</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># Let&#39;s plot our path with the custom functions</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="c1"># Visualize static map</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_graph_route</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">midday_path</span><span class="p">,</span> <span class="n">weight_col</span><span class="o">=</span><span class="s1">&#39;Keskpva_aa&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="c1"># Add the travel time as title</span>

<span class="ne">NameError</span>: name &#39;G&#39; is not defined
</pre></div>
</div>
</div>
</div>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                

              </div>
              
          </main>
          

      </div>
    </div>

    <script src="../_static/js/index.js"></script>
    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2020, Henrikki Tenkanen. Demonstration material for Aalto University.<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>